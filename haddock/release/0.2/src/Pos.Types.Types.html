<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE CPP                  #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE ConstraintKinds      #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables  #-}</span><span>
</span><a name="line-4"></a><span class="hs-pragma">{-# LANGUAGE TemplateHaskell      #-}</span><span>
</span><a name="line-5"></a><span class="hs-pragma">{-# LANGUAGE TypeFamilies         #-}</span><span>
</span><a name="line-6"></a><span class="hs-pragma">{-# LANGUAGE UndecidableInstances #-}</span><span>
</span><a name="line-7"></a><span class="hs-pragma">{-# OPTIONS_GHC -fno-warn-redundant-constraints #-}</span><span>
</span><a name="line-8"></a><span>
</span><a name="line-9"></a><span class="hs-comment">-- | Definitions of the most fundamental types.</span><span>
</span><a name="line-10"></a><span>
</span><a name="line-11"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span>
</span><a name="line-12"></a><span>       </span><span class="hs-special">(</span><span>
</span><a name="line-13"></a><span>         </span><span class="hs-comment">-- * Coin</span><span>
</span><a name="line-14"></a><span>         </span><a href="Pos.Types.Types.html#Coin"><span class="hs-identifier hs-type">Coin</span></a><span>
</span><a name="line-15"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#CoinPortion"><span class="hs-identifier hs-type">CoinPortion</span></a><span>
</span><a name="line-16"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#coinF"><span class="hs-identifier hs-var">coinF</span></a><span>
</span><a name="line-17"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#getCoinPortion"><span class="hs-identifier hs-var">getCoinPortion</span></a><span>
</span><a name="line-18"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#mkCoin"><span class="hs-identifier hs-var">mkCoin</span></a><span>
</span><a name="line-19"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#unsafeCoinPortion"><span class="hs-identifier hs-var">unsafeCoinPortion</span></a><span>
</span><a name="line-20"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#unsafeGetCoin"><span class="hs-identifier hs-var">unsafeGetCoin</span></a><span>
</span><a name="line-21"></a><span>
</span><a name="line-22"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#EpochIndex"><span class="hs-identifier hs-type">EpochIndex</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-23"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#FlatSlotId"><span class="hs-identifier hs-type">FlatSlotId</span></a><span>
</span><a name="line-24"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#LocalSlotIndex"><span class="hs-identifier hs-type">LocalSlotIndex</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-25"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#SlotId"><span class="hs-identifier hs-type">SlotId</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-type">EpochOrSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-27"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#slotIdF"><span class="hs-identifier hs-var">slotIdF</span></a><span>
</span><a name="line-28"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#epochOrSlot"><span class="hs-identifier hs-var">epochOrSlot</span></a><span>
</span><a name="line-29"></a><span>
</span><a name="line-30"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Address.html#makePubKeyAddress"><span class="hs-identifier hs-var">makePubKeyAddress</span></a><span>
</span><a name="line-32"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Address.html#makeScriptAddress"><span class="hs-identifier hs-var">makeScriptAddress</span></a><span>
</span><a name="line-33"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Address.html#checkPubKeyAddress"><span class="hs-identifier hs-var">checkPubKeyAddress</span></a><span>
</span><a name="line-34"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Address.html#checkScriptAddress"><span class="hs-identifier hs-var">checkScriptAddress</span></a><span>
</span><a name="line-35"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Address.html#addressF"><span class="hs-identifier hs-var">addressF</span></a><span>
</span><a name="line-36"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Address.html#decodeTextAddress"><span class="hs-identifier hs-var">decodeTextAddress</span></a><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Address.html#StakeholderId"><span class="hs-identifier hs-type">StakeholderId</span></a><span>
</span><a name="line-39"></a><span>
</span><a name="line-40"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#TxAttributes"><span class="hs-identifier hs-type">TxAttributes</span></a><span>
</span><a name="line-41"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#TxInWitness"><span class="hs-identifier hs-type">TxInWitness</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-42"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#TxWitness"><span class="hs-identifier hs-type">TxWitness</span></a><span>
</span><a name="line-43"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#TxDistribution"><span class="hs-identifier hs-type">TxDistribution</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-44"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#TxSigData"><span class="hs-identifier hs-type">TxSigData</span></a><span>
</span><a name="line-45"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#TxSig"><span class="hs-identifier hs-type">TxSig</span></a><span>
</span><a name="line-46"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#TxId"><span class="hs-identifier hs-type">TxId</span></a><span>
</span><a name="line-47"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#TxIn"><span class="hs-identifier hs-type">TxIn</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-48"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#toPair"><span class="hs-identifier hs-var">toPair</span></a><span>
</span><a name="line-49"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#TxOut"><span class="hs-identifier hs-type">TxOut</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-50"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#txOutStake"><span class="hs-identifier hs-var">txOutStake</span></a><span>
</span><a name="line-51"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#Tx"><span class="hs-identifier hs-type">Tx</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-52"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#_txInputs"><span class="hs-identifier hs-var">_txInputs</span></a><span>
</span><a name="line-53"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#_txOutputs"><span class="hs-identifier hs-var">_txOutputs</span></a><span>
</span><a name="line-54"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#_txAttributes"><span class="hs-identifier hs-var">_txAttributes</span></a><span>
</span><a name="line-55"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#txF"><span class="hs-identifier hs-var">txF</span></a><span>
</span><a name="line-56"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#txaF"><span class="hs-identifier hs-var">txaF</span></a><span>
</span><a name="line-57"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#TxAux"><span class="hs-identifier hs-type">TxAux</span></a><span>
</span><a name="line-58"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#TxOutAux"><span class="hs-identifier hs-type">TxOutAux</span></a><span>
</span><a name="line-59"></a><span>
</span><a name="line-60"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#Utxo"><span class="hs-identifier hs-type">Utxo</span></a><span>
</span><a name="line-61"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#formatUtxo"><span class="hs-identifier hs-var">formatUtxo</span></a><span>
</span><a name="line-62"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#utxoF"><span class="hs-identifier hs-var">utxoF</span></a><span>
</span><a name="line-63"></a><span>
</span><a name="line-64"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#TxUndo"><span class="hs-identifier hs-type">TxUndo</span></a><span>
</span><a name="line-65"></a><span>
</span><a name="line-66"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#SharedSeed"><span class="hs-identifier hs-type">SharedSeed</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-67"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#SlotLeaders"><span class="hs-identifier hs-type">SlotLeaders</span></a><span>
</span><a name="line-68"></a><span>
</span><a name="line-69"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#ProxySigEpoch"><span class="hs-identifier hs-type">ProxySigEpoch</span></a><span>
</span><a name="line-70"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#ProxySKEpoch"><span class="hs-identifier hs-type">ProxySKEpoch</span></a><span>
</span><a name="line-71"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#ProxySigSimple"><span class="hs-identifier hs-type">ProxySigSimple</span></a><span>
</span><a name="line-72"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#ProxySKSimple"><span class="hs-identifier hs-type">ProxySKSimple</span></a><span>
</span><a name="line-73"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#ProxySKEither"><span class="hs-identifier hs-type">ProxySKEither</span></a><span>
</span><a name="line-74"></a><span>
</span><a name="line-75"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#Blockchain"><span class="hs-identifier hs-type">Blockchain</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-76"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#BodyProof"><span class="hs-identifier hs-type">BodyProof</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-77"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#ConsensusData"><span class="hs-identifier hs-type">ConsensusData</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-78"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#Body"><span class="hs-identifier hs-type">Body</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-79"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#GenericBlockHeader"><span class="hs-identifier hs-type">GenericBlockHeader</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-80"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#GenericBlock"><span class="hs-identifier hs-type">GenericBlock</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-81"></a><span>
</span><a name="line-82"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#MainBlockchain"><span class="hs-identifier hs-type">MainBlockchain</span></a><span>
</span><a name="line-83"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#MainBlockHeader"><span class="hs-identifier hs-type">MainBlockHeader</span></a><span>
</span><a name="line-84"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#MainExtraBodyData"><span class="hs-identifier hs-type">MainExtraBodyData</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-85"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#MainExtraHeaderData"><span class="hs-identifier hs-type">MainExtraHeaderData</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-86"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#BlockHeaderAttributes"><span class="hs-identifier hs-type">BlockHeaderAttributes</span></a><span>
</span><a name="line-87"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#BlockBodyAttributes"><span class="hs-identifier hs-type">BlockBodyAttributes</span></a><span>
</span><a name="line-88"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#BiSsc"><span class="hs-identifier hs-type">BiSsc</span></a><span>
</span><a name="line-89"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#BlockSignature"><span class="hs-identifier hs-type">BlockSignature</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#ChainDifficulty"><span class="hs-identifier hs-type">ChainDifficulty</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-91"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#MainToSign"><span class="hs-identifier hs-type">MainToSign</span></a><span>
</span><a name="line-92"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#MainBlock"><span class="hs-identifier hs-type">MainBlock</span></a><span>
</span><a name="line-93"></a><span>
</span><a name="line-94"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#GenesisBlockchain"><span class="hs-identifier hs-type">GenesisBlockchain</span></a><span>
</span><a name="line-95"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#GenesisBlockHeader"><span class="hs-identifier hs-type">GenesisBlockHeader</span></a><span>
</span><a name="line-96"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#GenesisBlock"><span class="hs-identifier hs-type">GenesisBlock</span></a><span>
</span><a name="line-97"></a><span>
</span><a name="line-98"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#BlockHeader"><span class="hs-identifier hs-type">BlockHeader</span></a><span>
</span><a name="line-99"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#Block"><span class="hs-identifier hs-type">Block</span></a><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span>       </span><span class="hs-comment">-- * HeaderHash related types and functions</span><span>
</span><a name="line-102"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#BlockHeaderStub"><span class="hs-identifier hs-type">BlockHeaderStub</span></a><span>
</span><a name="line-103"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#HeaderHash"><span class="hs-identifier hs-type">HeaderHash</span></a><span>
</span><a name="line-104"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#blockHeaderHash"><span class="hs-identifier hs-var">blockHeaderHash</span></a><span>
</span><a name="line-105"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#headerHashF"><span class="hs-identifier hs-var">headerHashF</span></a><span>
</span><a name="line-106"></a><span>
</span><a name="line-107"></a><span>       </span><span class="hs-comment">-- * Lenses</span><span>
</span><a name="line-108"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#HasDifficulty"><span class="hs-identifier hs-type">HasDifficulty</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-109"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#HasEpochIndex"><span class="hs-identifier hs-type">HasEpochIndex</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-110"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#HasHeaderHash"><span class="hs-identifier hs-type">HasHeaderHash</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-111"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#HasPrevBlock"><span class="hs-identifier hs-type">HasPrevBlock</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-112"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#HasEpochOrSlot"><span class="hs-identifier hs-type">HasEpochOrSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><a name="line-113"></a><span>
</span><a name="line-114"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#blockHeader"><span class="hs-identifier hs-var">blockHeader</span></a><span>
</span><a name="line-115"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#blockLeaderKey"><span class="hs-identifier hs-var">blockLeaderKey</span></a><span>
</span><a name="line-116"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#blockLeaders"><span class="hs-identifier hs-var">blockLeaders</span></a><span>
</span><a name="line-117"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#blockMpc"><span class="hs-identifier hs-var">blockMpc</span></a><span>
</span><a name="line-118"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#blockSignature"><span class="hs-identifier hs-var">blockSignature</span></a><span>
</span><a name="line-119"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#blockSlot"><span class="hs-identifier hs-var">blockSlot</span></a><span>
</span><a name="line-120"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#blockTxs"><span class="hs-identifier hs-var">blockTxs</span></a><span>
</span><a name="line-121"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#blockTxas"><span class="hs-identifier hs-var">blockTxas</span></a><span>
</span><a name="line-122"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#blockProxySKs"><span class="hs-identifier hs-var">blockProxySKs</span></a><span>
</span><a name="line-123"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#gbBody"><span class="hs-identifier hs-var">gbBody</span></a><span>
</span><a name="line-124"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#gbBodyProof"><span class="hs-identifier hs-var">gbBodyProof</span></a><span>
</span><a name="line-125"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#gbExtra"><span class="hs-identifier hs-var">gbExtra</span></a><span>
</span><a name="line-126"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#gbHeader"><span class="hs-identifier hs-var">gbHeader</span></a><span>
</span><a name="line-127"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#gcdDifficulty"><span class="hs-identifier hs-var">gcdDifficulty</span></a><span>
</span><a name="line-128"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#gcdEpoch"><span class="hs-identifier hs-var">gcdEpoch</span></a><span>
</span><a name="line-129"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#gbhConsensus"><span class="hs-identifier hs-var">gbhConsensus</span></a><span>
</span><a name="line-130"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#gbhExtra"><span class="hs-identifier hs-var">gbhExtra</span></a><span>
</span><a name="line-131"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#gbhPrevBlock"><span class="hs-identifier hs-var">gbhPrevBlock</span></a><span>
</span><a name="line-132"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#gbhBodyProof"><span class="hs-identifier hs-var">gbhBodyProof</span></a><span>
</span><a name="line-133"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#getBlockHeader"><span class="hs-identifier hs-var">getBlockHeader</span></a><span>
</span><a name="line-134"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#headerLeaderKey"><span class="hs-identifier hs-var">headerLeaderKey</span></a><span>
</span><a name="line-135"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#headerSignature"><span class="hs-identifier hs-var">headerSignature</span></a><span>
</span><a name="line-136"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#headerSlot"><span class="hs-identifier hs-var">headerSlot</span></a><span>
</span><a name="line-137"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#mbMpc"><span class="hs-identifier hs-var">mbMpc</span></a><span>
</span><a name="line-138"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#mbTxs"><span class="hs-identifier hs-var">mbTxs</span></a><span>
</span><a name="line-139"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#mbWitnesses"><span class="hs-identifier hs-var">mbWitnesses</span></a><span>
</span><a name="line-140"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#mbProxySKs"><span class="hs-identifier hs-var">mbProxySKs</span></a><span>
</span><a name="line-141"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#mbUpdatePayload"><span class="hs-identifier hs-var">mbUpdatePayload</span></a><span>
</span><a name="line-142"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#mcdSlot"><span class="hs-identifier hs-var">mcdSlot</span></a><span>
</span><a name="line-143"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#mcdLeaderKey"><span class="hs-identifier hs-var">mcdLeaderKey</span></a><span>
</span><a name="line-144"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#mcdDifficulty"><span class="hs-identifier hs-var">mcdDifficulty</span></a><span>
</span><a name="line-145"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#mcdSignature"><span class="hs-identifier hs-var">mcdSignature</span></a><span>
</span><a name="line-146"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#mehBlockVersion"><span class="hs-identifier hs-var">mehBlockVersion</span></a><span>
</span><a name="line-147"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#mehSoftwareVersion"><span class="hs-identifier hs-var">mehSoftwareVersion</span></a><span>
</span><a name="line-148"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#mehAttributes"><span class="hs-identifier hs-var">mehAttributes</span></a><span>
</span><a name="line-149"></a><span>       </span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#mebAttributes"><span class="hs-identifier hs-var">mebAttributes</span></a><span>
</span><a name="line-150"></a><span>       </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-151"></a><span>
</span><a name="line-152"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Exception</span><span>      </span><span class="hs-special">(</span><span class="hs-identifier hs-var">assert</span><span class="hs-special">)</span><span>
</span><a name="line-153"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Control</span><span class="hs-operator">.</span><span class="hs-identifier">Lens</span><span>           </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Getter</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">choosing</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">makeLenses</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">makeLensesFor</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">to</span><span class="hs-special">)</span><span>
</span><a name="line-154"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Data</span><span>              </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Data</span><span class="hs-special">)</span><span>
</span><a name="line-155"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">DeriveTH</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-var">derive</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">makeNFData</span><span class="hs-special">)</span><span>
</span><a name="line-156"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Hashable</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Hashable</span><span class="hs-special">)</span><span>
</span><a name="line-157"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Ix</span><span>                </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Ix</span><span class="hs-special">)</span><span>
</span><a name="line-158"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Map</span><span>               </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">M</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">toList</span><span class="hs-special">)</span><span>
</span><a name="line-159"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">SafeCopy</span><span>          </span><span class="hs-special">(</span><span class="hs-identifier hs-type">SafeCopy</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">base</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">contain</span><span class="hs-special">,</span><span>
</span><a name="line-160"></a><span>                                         </span><span class="hs-identifier hs-var">deriveSafeCopySimple</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">safeGet</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">safePut</span><span class="hs-special">)</span><span>
</span><a name="line-161"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Serialize</span><span>         </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Cereal</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">getWord8</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">putWord8</span><span class="hs-special">)</span><span>
</span><a name="line-162"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Tagged</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-var">untag</span><span class="hs-special">)</span><span>
</span><a name="line-163"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Buildable</span><span>    </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Buildable</span><span class="hs-special">)</span><span>
</span><a name="line-164"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Buildable</span><span>    </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">Buildable</span><span>
</span><a name="line-165"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span class="hs-operator">.</span><span class="hs-identifier">Lazy</span><span class="hs-operator">.</span><span class="hs-identifier">Builder</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Builder</span><span class="hs-special">)</span><span>
</span><a name="line-166"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Vector</span><span>            </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Vector</span><span class="hs-special">)</span><span>
</span><a name="line-167"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Formatting</span><span>             </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Format</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">bprint</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">build</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">int</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">later</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">ords</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">sformat</span><span class="hs-special">,</span><span>
</span><a name="line-168"></a><span>                                         </span><span class="hs-identifier hs-var">stext</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-operator hs-var">%</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-169"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">AcidState</span><span>     </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-170"></a><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Base16</span><span>   </span><span class="hs-keyword">as</span><span> </span><span class="hs-identifier">B16</span><span>
</span><a name="line-171"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Serokell</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span><span class="hs-operator">.</span><span class="hs-identifier">Text</span><span>     </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listBuilderJSON</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">listJson</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">listJsonIndent</span><span class="hs-special">,</span><span>
</span><a name="line-172"></a><span>                                         </span><span class="hs-identifier hs-var">mapBuilderJson</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pairBuilder</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">pairF</span><span class="hs-special">)</span><span>
</span><a name="line-173"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Universum</span><span>
</span><a name="line-174"></a><span>
</span><a name="line-175"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Binary.Address.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Address</span></a><span>     </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-176"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Binary.Class.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span></a><span>       </span><span class="hs-special">(</span><a href="Pos.Binary.Class.html#Bi"><span class="hs-identifier hs-type">Bi</span></a><span class="hs-special">)</span><span>
</span><a name="line-177"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Binary.Script.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Binary</span><span class="hs-operator">.</span><span class="hs-identifier">Script</span></a><span>      </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-178"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Crypto.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Crypto</span></a><span>             </span><span class="hs-special">(</span><a href="Pos.Crypto.Hashing.html#Hash"><span class="hs-identifier hs-type">Hash</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Crypto.Signing.html#ProxySecretKey"><span class="hs-identifier hs-type">ProxySecretKey</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Crypto.Signing.html#ProxySignature"><span class="hs-identifier hs-type">ProxySignature</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Crypto.Signing.html#PublicKey"><span class="hs-identifier hs-type">PublicKey</span></a><span class="hs-special">,</span><span>
</span><a name="line-179"></a><span>                                         </span><a href="Pos.Crypto.Signing.html#Signature"><span class="hs-identifier hs-type">Signature</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Crypto.Hashing.html#hash"><span class="hs-identifier hs-var">hash</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Crypto.Hashing.html#hashHexF"><span class="hs-identifier hs-var">hashHexF</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Crypto.Hashing.html#shortHashF"><span class="hs-identifier hs-var">shortHashF</span></a><span class="hs-special">,</span><span>
</span><a name="line-180"></a><span>                                         </span><a href="Pos.Crypto.Hashing.html#unsafeHash"><span class="hs-identifier hs-var">unsafeHash</span></a><span class="hs-special">)</span><span>
</span><a name="line-181"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Data.Attributes.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Data</span><span class="hs-operator">.</span><span class="hs-identifier">Attributes</span></a><span>    </span><span class="hs-special">(</span><a href="Pos.Data.Attributes.html#Attributes"><span class="hs-identifier hs-type">Attributes</span></a><span class="hs-special">)</span><span>
</span><a name="line-182"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Merkle.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Merkle</span></a><span>             </span><span class="hs-special">(</span><a href="Pos.Merkle.html#MerkleRoot"><span class="hs-identifier hs-type">MerkleRoot</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Merkle.html#MerkleTree"><span class="hs-identifier hs-type">MerkleTree</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Merkle.html#mtRoot"><span class="hs-identifier hs-var">mtRoot</span></a><span class="hs-special">)</span><span>
</span><a name="line-183"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Script.Type.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Script</span><span class="hs-operator">.</span><span class="hs-identifier">Type</span></a><span>        </span><span class="hs-special">(</span><a href="Pos.Script.Type.html#Script"><span class="hs-identifier hs-type">Script</span></a><span class="hs-special">)</span><span>
</span><a name="line-184"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Ssc.Class.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Ssc</span><span class="hs-operator">.</span><span class="hs-identifier">Class</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>    </span><span class="hs-special">(</span><a href="Pos.Ssc.Class.Types.html#Ssc"><span class="hs-identifier hs-type">Ssc</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><a name="line-185"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Types.Address.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span class="hs-operator">.</span><span class="hs-identifier">Address</span></a><span>      </span><span class="hs-special">(</span><a href="Pos.Types.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a><span> </span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Types.Address.html#StakeholderId"><span class="hs-identifier hs-type">StakeholderId</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Types.Address.html#addressF"><span class="hs-identifier hs-var">addressF</span></a><span class="hs-special">,</span><span>
</span><a name="line-186"></a><span>                                         </span><a href="Pos.Types.Address.html#checkPubKeyAddress"><span class="hs-identifier hs-var">checkPubKeyAddress</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Types.Address.html#checkScriptAddress"><span class="hs-identifier hs-var">checkScriptAddress</span></a><span class="hs-special">,</span><span>
</span><a name="line-187"></a><span>                                         </span><a href="Pos.Types.Address.html#decodeTextAddress"><span class="hs-identifier hs-var">decodeTextAddress</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Types.Address.html#makePubKeyAddress"><span class="hs-identifier hs-var">makePubKeyAddress</span></a><span class="hs-special">,</span><span>
</span><a name="line-188"></a><span>                                         </span><a href="Pos.Types.Address.html#makeScriptAddress"><span class="hs-identifier hs-var">makeScriptAddress</span></a><span class="hs-special">)</span><span>
</span><a name="line-189"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Types.Version.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span><span class="hs-operator">.</span><span class="hs-identifier">Version</span></a><span>      </span><span class="hs-special">(</span><a href="Pos.Types.Version.html#BlockVersion"><span class="hs-identifier hs-type">BlockVersion</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Types.Version.html#SoftwareVersion"><span class="hs-identifier hs-type">SoftwareVersion</span></a><span class="hs-special">)</span><span>
</span><a name="line-190"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Update.Core.Types.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Update</span><span class="hs-operator">.</span><span class="hs-identifier">Core</span><span class="hs-operator">.</span><span class="hs-identifier">Types</span></a><span>  </span><span class="hs-special">(</span><a href="Pos.Update.Core.Types.html#UpdatePayload"><span class="hs-identifier hs-type">UpdatePayload</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Update.Core.Types.html#UpdateProof"><span class="hs-identifier hs-type">UpdateProof</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Update.Core.Types.html#mkUpdateProof"><span class="hs-identifier hs-var">mkUpdateProof</span></a><span class="hs-special">)</span><span>
</span><a name="line-191"></a><span class="hs-keyword">import</span><span>           </span><a href="Pos.Util.html"><span class="hs-identifier">Pos</span><span class="hs-operator">.</span><span class="hs-identifier">Util</span></a><span>               </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Color</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Magenta</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><a href="Pos.Util.html#colorize"><span class="hs-identifier hs-var">colorize</span></a><span class="hs-special">)</span><span>
</span><a name="line-192"></a><span>
</span><a name="line-193"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-194"></a><span class="hs-comment">-- Coin</span><span>
</span><a name="line-195"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-196"></a><span>
</span><a name="line-197"></a><span class="hs-comment">-- | Coin is the least possible unit of currency.</span><span>
</span><a name="line-198"></a><span class="hs-keyword">newtype</span><span> </span><a name="Coin"><a href="Pos.Types.Types.html#Coin"><span class="hs-identifier">Coin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Coin"><a href="Pos.Types.Types.html#Coin"><span class="hs-identifier">Coin</span></a></a><span>
</span><a name="line-199"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="getCoin"><a href="Pos.Types.Types.html#getCoin"><span class="hs-identifier">getCoin</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-200"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bounded</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Hashable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Data</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">NFData</span><span class="hs-special">)</span><span>
</span><a name="line-201"></a><span>
</span><a name="line-202"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="Pos.Types.Types.html#Coin"><span class="hs-identifier hs-type">Coin</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-203"></a><span>    </span><a name="local-1912614678"><span class="hs-identifier">build</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Types.Types.html#Coin"><span class="hs-identifier hs-var">Coin</span></a><span> </span><a name="local-1628066600"><a href="#local-1628066600"><span class="hs-identifier">n</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">int</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; coin(s)&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1628066600"><span class="hs-identifier hs-var">n</span></a><span>
</span><a name="line-204"></a><span>
</span><a name="line-205"></a><span class="hs-comment">-- | Make Coin from Word64.</span><span>
</span><a name="line-206"></a><span class="hs-identifier">mkCoin</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Types.Types.html#Coin"><span class="hs-identifier hs-type">Coin</span></a><span>
</span><a name="line-207"></a><a name="mkCoin"><a href="Pos.Types.Types.html#mkCoin"><span class="hs-identifier">mkCoin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Types.Types.html#Coin"><span class="hs-identifier hs-var">Coin</span></a><span>
</span><a name="line-208"></a><span class="hs-pragma">{-# INLINE mkCoin #-}</span><span>
</span><a name="line-209"></a><span>
</span><a name="line-210"></a><span class="hs-comment">-- | Coin formatter which restricts type.</span><span>
</span><a name="line-211"></a><span class="hs-identifier">coinF</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Format</span><span> </span><a href="#local-1628066563"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Types.Types.html#Coin"><span class="hs-identifier hs-type">Coin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066563"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-212"></a><a name="coinF"><a href="Pos.Types.Types.html#coinF"><span class="hs-identifier">coinF</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">build</span><span>
</span><a name="line-213"></a><span>
</span><a name="line-214"></a><span class="hs-comment">-- | Unwraps 'Coin'. It's called &#8220;unsafe&#8221; so that people wouldn't use it</span><span>
</span><a name="line-215"></a><span class="hs-comment">-- willy-nilly if they want to sum coins or something. It's actually safe.</span><span>
</span><a name="line-216"></a><span class="hs-identifier">unsafeGetCoin</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Types.Types.html#Coin"><span class="hs-identifier hs-type">Coin</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-217"></a><a name="unsafeGetCoin"><a href="Pos.Types.Types.html#unsafeGetCoin"><span class="hs-identifier">unsafeGetCoin</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">getCoin</span><span>
</span><a name="line-218"></a><span class="hs-pragma">{-# INLINE unsafeGetCoin #-}</span><span>
</span><a name="line-219"></a><span>
</span><a name="line-220"></a><span class="hs-comment">-- | CoinPortion is some portion of Coin, it must be in [0 .. 1]. Main</span><span>
</span><a name="line-221"></a><span class="hs-comment">-- usage of it is multiplication with Coin. Usually it's needed to</span><span>
</span><a name="line-222"></a><span class="hs-comment">-- determine some threshold expressed as portion of total stake.</span><span>
</span><a name="line-223"></a><span class="hs-keyword">newtype</span><span> </span><a name="CoinPortion"><a href="Pos.Types.Types.html#CoinPortion"><span class="hs-identifier">CoinPortion</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="CoinPortion"><a href="Pos.Types.Types.html#CoinPortion"><span class="hs-identifier">CoinPortion</span></a></a><span>
</span><a name="line-224"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="getCoinPortion"><a href="Pos.Types.Types.html#getCoinPortion"><span class="hs-identifier">getCoinPortion</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-225"></a><span>    </span><span class="hs-special">}</span><span>
</span><a name="line-226"></a><span>
</span><a name="line-227"></a><span class="hs-comment">-- | Make CoinPortion from Double. Caller must ensure that value is in [0 .. 1].</span><span>
</span><a name="line-228"></a><span class="hs-identifier">unsafeCoinPortion</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Types.Types.html#CoinPortion"><span class="hs-identifier hs-type">CoinPortion</span></a><span>
</span><a name="line-229"></a><a name="unsafeCoinPortion"><a href="Pos.Types.Types.html#unsafeCoinPortion"><span class="hs-identifier">unsafeCoinPortion</span></a></a><span> </span><a name="local-1628066564"><a href="#local-1628066564"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">assert</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-1628066564"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&amp;&amp;</span><span> </span><a href="#local-1628066564"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-number">1</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="Pos.Types.Types.html#CoinPortion"><span class="hs-identifier hs-var">CoinPortion</span></a><span> </span><a href="#local-1628066564"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-230"></a><span class="hs-pragma">{-# INLINE unsafeCoinPortion #-}</span><span>
</span><a name="line-231"></a><span>
</span><a name="line-232"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-233"></a><span class="hs-comment">-- Slotting</span><span>
</span><a name="line-234"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-235"></a><span>
</span><a name="line-236"></a><span class="hs-comment">-- | Index of epoch.</span><span>
</span><a name="line-237"></a><span class="hs-keyword">newtype</span><span> </span><a name="EpochIndex"><a href="Pos.Types.Types.html#EpochIndex"><span class="hs-identifier">EpochIndex</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="EpochIndex"><a href="Pos.Types.Types.html#EpochIndex"><span class="hs-identifier">EpochIndex</span></a></a><span>
</span><a name="line-238"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="getEpochIndex"><a href="Pos.Types.Types.html#getEpochIndex"><span class="hs-identifier">getEpochIndex</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-239"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Num</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Integral</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Real</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Hashable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Bounded</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-240"></a><span>
</span><a name="line-241"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="Pos.Types.Types.html#EpochIndex"><span class="hs-identifier hs-type">EpochIndex</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-242"></a><span>    </span><a name="local-1912614678"><span class="hs-identifier">build</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;epoch #&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">int</span><span class="hs-special">)</span><span>
</span><a name="line-243"></a><span>
</span><a name="line-244"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><span class="hs-special">(</span><a href="Pos.Types.Types.html#EpochIndex"><span class="hs-identifier hs-type">EpochIndex</span></a><span class="hs-special">,</span><a href="Pos.Types.Types.html#EpochIndex"><span class="hs-identifier hs-type">EpochIndex</span></a><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-245"></a><span>    </span><a name="local-1912614678"><span class="hs-identifier">build</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;epochIndices: &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">pairF</span><span class="hs-special">)</span><span>
</span><a name="line-246"></a><span>
</span><a name="line-247"></a><span class="hs-comment">-- | Index of slot inside a concrete epoch.</span><span>
</span><a name="line-248"></a><span class="hs-keyword">newtype</span><span> </span><a name="LocalSlotIndex"><a href="Pos.Types.Types.html#LocalSlotIndex"><span class="hs-identifier">LocalSlotIndex</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="LocalSlotIndex"><a href="Pos.Types.Types.html#LocalSlotIndex"><span class="hs-identifier">LocalSlotIndex</span></a></a><span>
</span><a name="line-249"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="getSlotIndex"><a href="Pos.Types.Types.html#getSlotIndex"><span class="hs-identifier">getSlotIndex</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word16</span><span>
</span><a name="line-250"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Num</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Enum</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ix</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Integral</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Real</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Hashable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-251"></a><span>
</span><a name="line-252"></a><span class="hs-comment">-- | Slot is identified by index of epoch and local index of slot in</span><span>
</span><a name="line-253"></a><span class="hs-comment">-- this epoch. This is a global index</span><span>
</span><a name="line-254"></a><span class="hs-keyword">data</span><span> </span><a name="SlotId"><a href="Pos.Types.Types.html#SlotId"><span class="hs-identifier">SlotId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="SlotId"><a href="Pos.Types.Types.html#SlotId"><span class="hs-identifier">SlotId</span></a></a><span>
</span><a name="line-255"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="siEpoch"><a href="Pos.Types.Types.html#siEpoch"><span class="hs-identifier">siEpoch</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Types.Types.html#EpochIndex"><span class="hs-identifier hs-type">EpochIndex</span></a><span>
</span><a name="line-256"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="siSlot"><a href="Pos.Types.Types.html#siSlot"><span class="hs-identifier">siSlot</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Types.Types.html#LocalSlotIndex"><span class="hs-identifier hs-type">LocalSlotIndex</span></a><span>
</span><a name="line-257"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-258"></a><span>
</span><a name="line-259"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="Pos.Types.Types.html#SlotId"><span class="hs-identifier hs-type">SlotId</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-260"></a><span>    </span><a name="local-1912614678"><span class="hs-identifier">build</span></a><span> </span><a href="Pos.Types.Types.html#SlotId"><span class="hs-identifier hs-var">SlotId</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-261"></a><span>        </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">ords</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; slot of &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">ords</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; epoch&quot;</span><span class="hs-special">)</span><span> </span><a href="#local-1628066599"><span class="hs-identifier hs-var">siSlot</span></a><span> </span><a href="#local-1628066598"><span class="hs-identifier hs-var">siEpoch</span></a><span>
</span><a name="line-262"></a><span>
</span><a name="line-263"></a><span class="hs-comment">-- | Specialized formatter for 'SlotId'.</span><span>
</span><a name="line-264"></a><span class="hs-identifier">slotIdF</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Format</span><span> </span><a href="#local-1628066562"><span class="hs-identifier hs-type">r</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Types.Types.html#SlotId"><span class="hs-identifier hs-type">SlotId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066562"><span class="hs-identifier hs-type">r</span></a><span class="hs-special">)</span><span>
</span><a name="line-265"></a><a name="slotIdF"><a href="Pos.Types.Types.html#slotIdF"><span class="hs-identifier">slotIdF</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">build</span><span>
</span><a name="line-266"></a><span>
</span><a name="line-267"></a><span class="hs-comment">-- | FlatSlotId is a flat version of SlotId</span><span>
</span><a name="line-268"></a><span class="hs-keyword">type</span><span> </span><a name="FlatSlotId"><a href="Pos.Types.Types.html#FlatSlotId"><span class="hs-identifier">FlatSlotId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-269"></a><span>
</span><a name="line-270"></a><span class="hs-comment">-- | Represents SlotId or EpochIndex. Useful because genesis blocks</span><span>
</span><a name="line-271"></a><span class="hs-comment">-- have only EpochIndex, while main blocks have SlotId.</span><span>
</span><a name="line-272"></a><span class="hs-keyword">newtype</span><span> </span><a name="EpochOrSlot"><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier">EpochOrSlot</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="EpochOrSlot"><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier">EpochOrSlot</span></a></a><span>
</span><a name="line-273"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="unEpochOrSlot"><a href="Pos.Types.Types.html#unEpochOrSlot"><span class="hs-identifier">unEpochOrSlot</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Either</span><span> </span><a href="Pos.Types.Types.html#EpochIndex"><span class="hs-identifier hs-type">EpochIndex</span></a><span> </span><a href="Pos.Types.Types.html#SlotId"><span class="hs-identifier hs-type">SlotId</span></a><span>
</span><a name="line-274"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">)</span><span>
</span><a name="line-275"></a><span>
</span><a name="line-276"></a><span class="hs-comment">-- | Apply one of the function depending on content of EpochOrSlot.</span><span>
</span><a name="line-277"></a><span class="hs-identifier">epochOrSlot</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><a href="Pos.Types.Types.html#EpochIndex"><span class="hs-identifier hs-type">EpochIndex</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066561"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Pos.Types.Types.html#SlotId"><span class="hs-identifier hs-type">SlotId</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066561"><span class="hs-identifier hs-type">a</span></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-type">EpochOrSlot</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066561"><span class="hs-identifier hs-type">a</span></a><span>
</span><a name="line-278"></a><a name="epochOrSlot"><a href="Pos.Types.Types.html#epochOrSlot"><span class="hs-identifier">epochOrSlot</span></a></a><span> </span><a name="local-1628066565"><a href="#local-1628066565"><span class="hs-identifier">f</span></a></a><span> </span><a name="local-1628066566"><a href="#local-1628066566"><span class="hs-identifier">g</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><a href="#local-1628066565"><span class="hs-identifier hs-var">f</span></a><span> </span><a href="#local-1628066566"><span class="hs-identifier hs-var">g</span></a><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unEpochOrSlot</span><span>
</span><a name="line-279"></a><span>
</span><a name="line-280"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Ord</span><span> </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-type">EpochOrSlot</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-281"></a><span>    </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-var">EpochOrSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-1628066584"><a href="#local-1628066584"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1912608786"><span class="hs-operator">&lt;</span></a><span> </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-var">EpochOrSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-1628066585"><a href="#local-1628066585"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066584"><span class="hs-identifier hs-var">e1</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-1628066585"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-282"></a><span>    </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-var">EpochOrSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-1628066586"><a href="#local-1628066586"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-operator">&lt;</span><span> </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-var">EpochOrSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-1628066587"><a href="#local-1628066587"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066586"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-1628066587"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-283"></a><span>    </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-var">EpochOrSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-1628066588"><a href="#local-1628066588"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-operator">&lt;</span><span> </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-var">EpochOrSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-1628066589"><a href="#local-1628066589"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier">siEpoch</span><span> </span><a href="#local-1628066588"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-1628066589"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-284"></a><span>    </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-var">EpochOrSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-1628066590"><a href="#local-1628066590"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-operator">&lt;</span><span> </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-var">EpochOrSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-1628066591"><a href="#local-1628066591"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066590"><span class="hs-identifier hs-var">e1</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><span class="hs-identifier">siEpoch</span><span> </span><a href="#local-1628066591"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-285"></a><span>    </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-var">EpochOrSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-1628066592"><a href="#local-1628066592"><span class="hs-identifier">e1</span></a></a><span class="hs-special">)</span><span> </span><a name="local-1912608782"><span class="hs-operator">&lt;=</span></a><span> </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-var">EpochOrSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Left</span><span> </span><a name="local-1628066593"><a href="#local-1628066593"><span class="hs-identifier">e2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066592"><span class="hs-identifier hs-var">e1</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-1628066593"><span class="hs-identifier hs-var">e2</span></a><span>
</span><a name="line-286"></a><span>    </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-var">EpochOrSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-1628066594"><a href="#local-1628066594"><span class="hs-identifier">s1</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-operator">&lt;=</span><span> </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-var">EpochOrSlot</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">Right</span><span> </span><a name="local-1628066595"><a href="#local-1628066595"><span class="hs-identifier">s2</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066594"><span class="hs-identifier hs-var">s1</span></a><span> </span><span class="hs-operator hs-var">&lt;=</span><span> </span><a href="#local-1628066595"><span class="hs-identifier hs-var">s2</span></a><span>
</span><a name="line-287"></a><span>    </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-var">EpochOrSlot</span></a><span> </span><a name="local-1628066596"><a href="#local-1628066596"><span class="hs-identifier">a</span></a></a><span> </span><span class="hs-operator">&lt;=</span><span> </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-var">EpochOrSlot</span></a><span> </span><a name="local-1628066597"><a href="#local-1628066597"><span class="hs-identifier">b</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="#local-1628066596"><span class="hs-identifier hs-var">a</span></a><span> </span><span class="hs-operator hs-var">&lt;</span><span> </span><a href="#local-1628066597"><span class="hs-identifier hs-var">b</span></a><span>
</span><a name="line-288"></a><span>
</span><a name="line-289"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="Pos.Types.Types.html#EpochOrSlot"><span class="hs-identifier hs-type">EpochOrSlot</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-290"></a><span>    </span><a name="local-1912614678"><span class="hs-identifier">build</span></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">either</span><span> </span><span class="hs-identifier hs-var">Buildable</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">build</span><span> </span><span class="hs-identifier hs-var">Buildable</span><span class="hs-operator hs-var">.</span><span class="hs-identifier hs-var">build</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier">unEpochOrSlot</span><span>
</span><a name="line-291"></a><span>
</span><a name="line-292"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-293"></a><span class="hs-comment">-- Transaction</span><span>
</span><a name="line-294"></a><span class="hs-comment">----------------------------------------------------------------------------</span><span>
</span><a name="line-295"></a><span>
</span><a name="line-296"></a><span class="hs-comment">-- | Represents transaction attributes: map from 1-byte integer to</span><span>
</span><a name="line-297"></a><span class="hs-comment">-- arbitrary-type value. To be used for extending transaction with new</span><span>
</span><a name="line-298"></a><span class="hs-comment">-- fields via softfork.</span><span>
</span><a name="line-299"></a><span class="hs-keyword">type</span><span> </span><a name="TxAttributes"><a href="Pos.Types.Types.html#TxAttributes"><span class="hs-identifier">TxAttributes</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Data.Attributes.html#Attributes"><span class="hs-identifier hs-type">Attributes</span></a><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><a name="line-300"></a><span>
</span><a name="line-301"></a><span class="hs-comment">-- | Represents transaction identifier as 'Hash' of 'Tx'.</span><span>
</span><a name="line-302"></a><span class="hs-keyword">type</span><span> </span><a name="TxId"><a href="Pos.Types.Types.html#TxId"><span class="hs-identifier">TxId</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Crypto.Hashing.html#Hash"><span class="hs-identifier hs-type">Hash</span></a><span> </span><a href="Pos.Types.Types.html#Tx"><span class="hs-identifier hs-type">Tx</span></a><span>
</span><a name="line-303"></a><span>
</span><a name="line-304"></a><span class="hs-comment">-- | Data that is being signed when creating a TxSig.</span><span>
</span><a name="line-305"></a><span class="hs-keyword">type</span><span> </span><a name="TxSigData"><a href="Pos.Types.Types.html#TxSigData"><span class="hs-identifier">TxSigData</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Pos.Types.Types.html#TxId"><span class="hs-identifier hs-type">TxId</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Word32</span><span class="hs-special">,</span><span> </span><a href="Pos.Crypto.Hashing.html#Hash"><span class="hs-identifier hs-type">Hash</span></a><span> </span><span class="hs-special">[</span><a href="Pos.Types.Types.html#TxOut"><span class="hs-identifier hs-type">TxOut</span></a><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><a href="Pos.Crypto.Hashing.html#Hash"><span class="hs-identifier hs-type">Hash</span></a><span> </span><a href="Pos.Types.Types.html#TxDistribution"><span class="hs-identifier hs-type">TxDistribution</span></a><span class="hs-special">)</span><span>
</span><a name="line-306"></a><span>
</span><a name="line-307"></a><span class="hs-comment">-- | 'Signature' of addrId.</span><span>
</span><a name="line-308"></a><span class="hs-keyword">type</span><span> </span><a name="TxSig"><a href="Pos.Types.Types.html#TxSig"><span class="hs-identifier">TxSig</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a href="Pos.Crypto.Signing.html#Signature"><span class="hs-identifier hs-type">Signature</span></a><span> </span><a href="Pos.Types.Types.html#TxSigData"><span class="hs-identifier hs-type">TxSigData</span></a><span>
</span><a name="line-309"></a><span>
</span><a name="line-310"></a><span class="hs-comment">-- | A witness for a single input.</span><span>
</span><a name="line-311"></a><span class="hs-keyword">data</span><span> </span><a name="TxInWitness"><a href="Pos.Types.Types.html#TxInWitness"><span class="hs-identifier">TxInWitness</span></a></a><span>
</span><a name="line-312"></a><span>    </span><span class="hs-glyph">=</span><span> </span><a name="PkWitness"><a href="Pos.Types.Types.html#PkWitness"><span class="hs-identifier">PkWitness</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="twKey"><a href="Pos.Types.Types.html#twKey"><span class="hs-identifier">twKey</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Crypto.Signing.html#PublicKey"><span class="hs-identifier hs-type">PublicKey</span></a><span>
</span><a name="line-313"></a><span>                </span><span class="hs-special">,</span><span> </span><a name="twSig"><a href="Pos.Types.Types.html#twSig"><span class="hs-identifier">twSig</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Types.Types.html#TxSig"><span class="hs-identifier hs-type">TxSig</span></a><span class="hs-special">}</span><span>
</span><a name="line-314"></a><span>    </span><span class="hs-glyph">|</span><span> </span><a name="ScriptWitness"><a href="Pos.Types.Types.html#ScriptWitness"><span class="hs-identifier">ScriptWitness</span></a></a><span> </span><span class="hs-special">{</span><span> </span><a name="twValidator"><a href="Pos.Types.Types.html#twValidator"><span class="hs-identifier">twValidator</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Script.Type.html#Script"><span class="hs-identifier hs-type">Script</span></a><span>
</span><a name="line-315"></a><span>                    </span><span class="hs-special">,</span><span> </span><a name="twRedeemer"><a href="Pos.Types.Types.html#twRedeemer"><span class="hs-identifier">twRedeemer</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Script.Type.html#Script"><span class="hs-identifier hs-type">Script</span></a><span class="hs-special">}</span><span>
</span><a name="line-316"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-317"></a><span>
</span><a name="line-318"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Hashable</span><span> </span><a href="Pos.Types.Types.html#TxInWitness"><span class="hs-identifier hs-type">TxInWitness</span></a><span>
</span><a name="line-319"></a><span>
</span><a name="line-320"></a><span class="hs-keyword">instance</span><span> </span><a href="Pos.Binary.Class.html#Bi"><span class="hs-identifier hs-type">Bi</span></a><span> </span><a href="Pos.Script.Type.html#Script"><span class="hs-identifier hs-type">Script</span></a><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="Pos.Types.Types.html#TxInWitness"><span class="hs-identifier hs-type">TxInWitness</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-321"></a><span>    </span><a name="local-1912614678"><span class="hs-identifier">build</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Types.Types.html#PkWitness"><span class="hs-identifier hs-var">PkWitness</span></a><span> </span><a name="local-1628066580"><a href="#local-1628066580"><span class="hs-identifier">key</span></a></a><span> </span><a name="local-1628066581"><a href="#local-1628066581"><span class="hs-identifier">sig</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-322"></a><span>        </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;PkWitness: key = &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;, sig = &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-special">)</span><span> </span><a href="#local-1628066580"><span class="hs-identifier hs-var">key</span></a><span> </span><a href="#local-1628066581"><span class="hs-identifier hs-var">sig</span></a><span>
</span><a name="line-323"></a><span>    </span><span class="hs-identifier">build</span><span> </span><span class="hs-special">(</span><a href="Pos.Types.Types.html#ScriptWitness"><span class="hs-identifier hs-var">ScriptWitness</span></a><span> </span><a name="local-1628066582"><a href="#local-1628066582"><span class="hs-identifier">val</span></a></a><span> </span><a name="local-1628066583"><a href="#local-1628066583"><span class="hs-identifier">red</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-324"></a><span>        </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;ScriptWitness: &quot;</span><span class="hs-operator hs-var">%</span><span>
</span><a name="line-325"></a><span>                </span><span class="hs-string">&quot;validator hash = &quot;</span><span class="hs-operator hs-var">%</span><a href="Pos.Crypto.Hashing.html#shortHashF"><span class="hs-identifier hs-var">shortHashF</span></a><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;, &quot;</span><span class="hs-operator hs-var">%</span><span>
</span><a name="line-326"></a><span>                </span><span class="hs-string">&quot;redeemer hash = &quot;</span><span class="hs-operator hs-var">%</span><a href="Pos.Crypto.Hashing.html#shortHashF"><span class="hs-identifier hs-var">shortHashF</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Pos.Crypto.Hashing.html#hash"><span class="hs-identifier hs-var">hash</span></a><span> </span><a href="#local-1628066582"><span class="hs-identifier hs-var">val</span></a><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><a href="Pos.Crypto.Hashing.html#hash"><span class="hs-identifier hs-var">hash</span></a><span> </span><a href="#local-1628066583"><span class="hs-identifier hs-var">red</span></a><span class="hs-special">)</span><span>
</span><a name="line-327"></a><span>
</span><a name="line-328"></a><span class="hs-comment">-- | A witness is a proof that a transaction is allowed to spend the funds it</span><span>
</span><a name="line-329"></a><span class="hs-comment">-- spends (by providing signatures, redeeming scripts, etc). A separate proof</span><span>
</span><a name="line-330"></a><span class="hs-comment">-- is provided for each input.</span><span>
</span><a name="line-331"></a><span class="hs-keyword">type</span><span> </span><a name="TxWitness"><a href="Pos.Types.Types.html#TxWitness"><span class="hs-identifier">TxWitness</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-type">Vector</span><span> </span><a href="Pos.Types.Types.html#TxInWitness"><span class="hs-identifier hs-type">TxInWitness</span></a><span>
</span><a name="line-332"></a><span>
</span><a name="line-333"></a><span class="hs-comment">-- | Distribution of &#8220;fake&#8221; stake that follow-the-satoshi would use for a</span><span>
</span><a name="line-334"></a><span class="hs-comment">-- particular transaction.</span><span>
</span><a name="line-335"></a><span class="hs-keyword">newtype</span><span> </span><a name="TxDistribution"><a href="Pos.Types.Types.html#TxDistribution"><span class="hs-identifier">TxDistribution</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TxDistribution"><a href="Pos.Types.Types.html#TxDistribution"><span class="hs-identifier">TxDistribution</span></a></a><span> </span><span class="hs-special">{</span><span>
</span><a name="line-336"></a><span>    </span><a name="getTxDistribution"><a href="Pos.Types.Types.html#getTxDistribution"><span class="hs-identifier">getTxDistribution</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Pos.Types.Address.html#StakeholderId"><span class="hs-identifier hs-type">StakeholderId</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#Coin"><span class="hs-identifier hs-type">Coin</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">]</span><span> </span><span class="hs-special">}</span><span>
</span><a name="line-337"></a><span>    </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-338"></a><span>
</span><a name="line-339"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="Pos.Types.Types.html#TxDistribution"><span class="hs-identifier hs-type">TxDistribution</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-340"></a><span>    </span><a name="local-1912614678"><span class="hs-identifier">build</span></a><span> </span><span class="hs-special">(</span><a href="Pos.Types.Types.html#TxDistribution"><span class="hs-identifier hs-var">TxDistribution</span></a><span> </span><a name="local-1628066579"><a href="#local-1628066579"><span class="hs-identifier">x</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-341"></a><span>        </span><span class="hs-identifier hs-var">listBuilderJSON</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">listBuilderJSON</span><span> </span><span class="hs-operator hs-var">.</span><span> </span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">pairBuilder</span><span class="hs-special">)</span><span> </span><span class="hs-operator hs-var">$</span><span> </span><a href="#local-1628066579"><span class="hs-identifier hs-var">x</span></a><span>
</span><a name="line-342"></a><span>
</span><a name="line-343"></a><span class="hs-comment">-- | Transaction input.</span><span>
</span><a name="line-344"></a><span class="hs-keyword">data</span><span> </span><a name="TxIn"><a href="Pos.Types.Types.html#TxIn"><span class="hs-identifier">TxIn</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TxIn"><a href="Pos.Types.Types.html#TxIn"><span class="hs-identifier">TxIn</span></a></a><span>
</span><a name="line-345"></a><span>    </span><span class="hs-special">{</span><span> </span><span class="hs-comment">-- | Which transaction's output is used</span><span>
</span><a name="line-346"></a><span>      </span><a name="txInHash"><a href="Pos.Types.Types.html#txInHash"><span class="hs-identifier">txInHash</span></a></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Types.Types.html#TxId"><span class="hs-identifier hs-type">TxId</span></a><span>
</span><a name="line-347"></a><span>      </span><span class="hs-comment">-- | Index of the output in transaction's outputs</span><span>
</span><a name="line-348"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="txInIndex"><a href="Pos.Types.Types.html#txInIndex"><span class="hs-identifier">txInIndex</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-identifier hs-type">Word32</span><span>
</span><a name="line-349"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-350"></a><span>
</span><a name="line-351"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Hashable</span><span> </span><a href="Pos.Types.Types.html#TxIn"><span class="hs-identifier hs-type">TxIn</span></a><span>
</span><a name="line-352"></a><span>
</span><a name="line-353"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="Pos.Types.Types.html#TxIn"><span class="hs-identifier hs-type">TxIn</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-354"></a><span>    </span><a name="local-1912614678"><span class="hs-identifier">build</span></a><span> </span><a href="Pos.Types.Types.html#TxIn"><span class="hs-identifier hs-var">TxIn</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;TxIn &quot;</span><span class="hs-operator hs-var">%</span><a href="Pos.Crypto.Hashing.html#shortHashF"><span class="hs-identifier hs-var">shortHashF</span></a><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; #&quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">int</span><span class="hs-special">)</span><span> </span><a href="#local-1628066577"><span class="hs-identifier hs-var">txInHash</span></a><span> </span><a href="#local-1628066578"><span class="hs-identifier hs-var">txInIndex</span></a><span>
</span><a name="line-355"></a><span>
</span><a name="line-356"></a><span class="hs-comment">-- | Make pair from TxIn</span><span>
</span><a name="line-357"></a><span class="hs-identifier">toPair</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Types.Types.html#TxIn"><span class="hs-identifier hs-type">TxIn</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><a href="Pos.Types.Types.html#TxId"><span class="hs-identifier hs-type">TxId</span></a><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Word32</span><span class="hs-special">)</span><span>
</span><a name="line-358"></a><a name="toPair"><a href="Pos.Types.Types.html#toPair"><span class="hs-identifier">toPair</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Types.Types.html#TxIn"><span class="hs-identifier hs-var">TxIn</span></a><span> </span><a name="local-1628066567"><a href="#local-1628066567"><span class="hs-identifier">h</span></a></a><span> </span><a name="local-1628066568"><a href="#local-1628066568"><span class="hs-identifier">i</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="#local-1628066567"><span class="hs-identifier hs-var">h</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066568"><span class="hs-identifier hs-var">i</span></a><span class="hs-special">)</span><span>
</span><a name="line-359"></a><span>
</span><a name="line-360"></a><span class="hs-comment">-- | Transaction output.</span><span>
</span><a name="line-361"></a><span class="hs-keyword">data</span><span> </span><a name="TxOut"><a href="Pos.Types.Types.html#TxOut"><span class="hs-identifier">TxOut</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="TxOut"><a href="Pos.Types.Types.html#TxOut"><span class="hs-identifier">TxOut</span></a></a><span>
</span><a name="line-362"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="txOutAddress"><a href="Pos.Types.Types.html#txOutAddress"><span class="hs-identifier">txOutAddress</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Types.Address.html#Address"><span class="hs-identifier hs-type">Address</span></a><span>
</span><a name="line-363"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="txOutValue"><a href="Pos.Types.Types.html#txOutValue"><span class="hs-identifier">txOutValue</span></a></a><span>   </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Types.Types.html#Coin"><span class="hs-identifier hs-type">Coin</span></a><span>
</span><a name="line-364"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-365"></a><span>
</span><a name="line-366"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Hashable</span><span> </span><a href="Pos.Types.Types.html#TxOut"><span class="hs-identifier hs-type">TxOut</span></a><span>
</span><a name="line-367"></a><span>
</span><a name="line-368"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="Pos.Types.Types.html#TxOut"><span class="hs-identifier hs-type">TxOut</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-369"></a><span>    </span><a name="local-1912614678"><span class="hs-identifier">build</span></a><span> </span><a href="Pos.Types.Types.html#TxOut"><span class="hs-identifier hs-var">TxOut</span></a><span> </span><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-370"></a><span>        </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;TxOut &quot;</span><span class="hs-operator hs-var">%</span><a href="Pos.Types.Types.html#coinF"><span class="hs-identifier hs-var">coinF</span></a><span class="hs-operator hs-var">%</span><span class="hs-string">&quot; -&gt; &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-special">)</span><span> </span><a href="#local-1628066576"><span class="hs-identifier hs-var">txOutValue</span></a><span> </span><a href="#local-1628066575"><span class="hs-identifier hs-var">txOutAddress</span></a><span>
</span><a name="line-371"></a><span>
</span><a name="line-372"></a><span class="hs-keyword">type</span><span> </span><a name="TxOutAux"><a href="Pos.Types.Types.html#TxOutAux"><span class="hs-identifier">TxOutAux</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><a href="Pos.Types.Types.html#TxOut"><span class="hs-identifier hs-type">TxOut</span></a><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Pos.Types.Address.html#StakeholderId"><span class="hs-identifier hs-type">StakeholderId</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#Coin"><span class="hs-identifier hs-type">Coin</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span>
</span><a name="line-373"></a><span>
</span><a name="line-374"></a><span class="hs-keyword">instance</span><span> </span><span class="hs-identifier hs-type">Buildable</span><span> </span><a href="Pos.Types.Types.html#TxOutAux"><span class="hs-identifier hs-type">TxOutAux</span></a><span> </span><span class="hs-keyword">where</span><span>
</span><a name="line-375"></a><span>    </span><a name="local-1912614678"><span class="hs-identifier">build</span></a><span> </span><span class="hs-special">(</span><a name="local-1628066573"><a href="#local-1628066573"><span class="hs-identifier">out</span></a></a><span class="hs-special">,</span><span> </span><a name="local-1628066574"><a href="#local-1628066574"><span class="hs-identifier">distr</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><a name="line-376"></a><span>        </span><span class="hs-identifier hs-var">bprint</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;{txout = &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">build</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;, distr = &quot;</span><span class="hs-operator hs-var">%</span><span class="hs-identifier hs-var">listJson</span><span class="hs-operator hs-var">%</span><span class="hs-string">&quot;}&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-377"></a><span>               </span><a href="#local-1628066573"><span class="hs-identifier hs-var">out</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-var">map</span><span> </span><span class="hs-identifier hs-var">pairBuilder</span><span> </span><a href="#local-1628066574"><span class="hs-identifier hs-var">distr</span></a><span class="hs-special">)</span><span>
</span><a name="line-378"></a><span>
</span><a name="line-379"></a><span class="hs-comment">-- | Use this function if you need to know how a 'TxOut' distributes stake</span><span>
</span><a name="line-380"></a><span class="hs-comment">-- (e.g. for the purpose of running follow-the-satoshi).</span><span>
</span><a name="line-381"></a><span class="hs-identifier">txOutStake</span><span> </span><span class="hs-glyph">::</span><span> </span><a href="Pos.Types.Types.html#TxOutAux"><span class="hs-identifier hs-type">TxOutAux</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="Pos.Types.Address.html#StakeholderId"><span class="hs-identifier hs-type">StakeholderId</span></a><span class="hs-special">,</span><span> </span><a href="Pos.Types.Types.html#Coin"><span class="hs-identifier hs-type">Coin</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-382"></a><a name="txOutStake"><a href="Pos.Types.Types.html#txOutStake"><span class="hs-identifier">txOutStake</span></a></a><span> </span><span class="hs-special">(</span><a href="Pos.Types.Types.html#TxOut"><span class="hs-identifier hs-var">TxOut</span></a><span class="hs-special">{</span><span class="hs-glyph">..</span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><a name="local-1628066571"><a href="#local-1628066571"><span class="hs-identifier">mb</span></a></a><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><a href="#local-1628066569"><span class="hs-identifier hs-var">txOutAddress</span></a><span> </span><span class="hs-keyword">of</span><span>
</span><a name="line-383"></a><span>    </span><a href="Pos.Types.Address.html#PubKeyAddress"><span class="hs-identifier hs-var">PubKeyAddress</span></a><span> </span><a name="local-1628066572"><a href="#local-1628066572"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><a href="#local-1628066572"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">,</span><span> </span><a href="#local-1628066570"><span class="hs-identifier hs-var">txOutValue</span></a><span class="hs-special">)</span><span class="hs-special">]</span><span>
</span><a name="line-384"></a><span>    </span><a href="Pos.Types.Address.html#ScriptAddress"><span class="hs-identifier hs-var">ScriptAddress</span></a><span> </span><span class="hs-identifier">_</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><a href="#local-1628066571"><span class="hs-identifier hs-var">mb</span></a><span>
</span><a name="line-385"></a><span>
</span><a name="line-386"></a><span class="hs-comment">-- | Transaction.</span><span>
</span><a name="line-387"></a><span class="hs-comment">--</span><span>
</span><a name="line-388"></a><span class="hs-comment">-- NB: transaction witnesses are stored separately.</span><span>
</span><a name="line-389"></a><span class="hs-keyword">data</span><span> </span><a name="Tx"><a href="Pos.Types.Types.html#Tx"><span class="hs-identifier">Tx</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><a name="Tx"><a href="Pos.Types.Types.html#Tx"><span class="hs-identifier">Tx</span></a></a><span>
</span><a name="line-390"></a><span>    </span><span class="hs-special">{</span><span> </span><a name="txInputs"><a href="Pos.Types.Types.html#txInputs"><span class="hs-identifier">txInputs</span></a></a><span>     </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><a href="Pos.Types.Types.html#TxIn"><span class="hs-identifier hs-type">TxIn</span></a><span class="hs-special">]</span><span>   </span><span class="hs-comment">-- ^ Inputs of transaction.</span><span>
</span><a name="line-391"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="txOutputs"><a href="Pos.Types.Types.html#txOutputs"><span class="hs-identifier">txOutputs</span></a></a><span>    </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><span class="hs-special">[</span><a href="Pos.Types.Types.html#TxOut"><span class="hs-identifier hs-type">TxOut</span></a><span class="hs-special">]</span><span>  </span><span class="hs-comment">-- ^ Outputs of transaction.</span><span>
</span><a name="line-392"></a><span>    </span><span class="hs-special">,</span><span> </span><a name="txAttributes"><a href="Pos.Types.Types.html#txAttributes"><span class="hs-identifier">txAttributes</span></a></a><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-glyph">!</span><a href="Pos.Types.Types.html#TxAttributes"><span class="hs-identifier hs-type">TxAttributes</span></a><span> </span><span class="hs-comment">-- ^ Attributes of transaction</span><span>
</span><a name="line-393"></a><span>    </span><span class="hs-special">}</span><span> </span><span class="hs-keyword">deriving</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">Eq</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Ord</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Generic</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Show</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Typeable</span><span class="hs-special">)</span><span>
</span><a name="line-394"></a><span>
</span><a name="line-395"></a><span class="hs-identifier hs-var">makeLensesFor</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="hs-string">&quot;txInputs&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;_txInputs&quot;</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;txOutputs&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;_txOutputs&quot;</span><span class="hs-special">)</span><span>
</span><a name="line-396"></a><span>              </span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-string">&quot;txAttributes&quot;</span><span class="hs-special">,</span><span> </span><span class="hs-string">&quot;_txAttributes&quot;</span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-char">''Tx

-- | Transaction + auxiliary data
type TxAux = (Tx, TxWitness, TxDistribution)

instance Hashable Tx

instance Buildable Tx where
    build Tx {..} =
        bprint
            (&quot;Transaction with inputs &quot;%listJson%&quot;, outputs: &quot;%listJson)
            txInputs txOutputs

-- | Specialized formatter for 'Tx'.
txF :: Format r (Tx -&gt; r)
txF = build

-- | Specialized formatter for 'Tx' with auxiliary data
txaF :: Bi Script =&gt; Format r (TxAux -&gt; r)
txaF = later $ \(tx, w, d) -&gt;
    bprint (build%&quot;\n&quot;%
            &quot;witnesses: &quot;%listJsonIndent 4%&quot;\n&quot;%
            &quot;distribution: &quot;%build) tx w d

----------------------------------------------------------------------------
-- UTXO
----------------------------------------------------------------------------

-- | Unspent transaction outputs.
--
-- Transaction inputs are identified by (transaction ID, index in list of
-- output) pairs.
type Utxo = Map (TxId, Word32) TxOutAux

-- | Format 'Utxo' map as json.
formatUtxo :: Utxo -&gt; Builder
formatUtxo =
    mapBuilderJson .
    map (first pairBuilder . second (show @_ @Text)) .
    M.toList

-- | Specialized formatter for 'Utxo'.
utxoF :: Format r (Utxo -&gt; r)
utxoF = later formatUtxo

----------------------------------------------------------------------------
-- UNDO
----------------------------------------------------------------------------

-- | Particular undo needed for transactions
type TxUndo = [[TxOutAux]]

----------------------------------------------------------------------------
-- SSC. It means shared seed computation, btw
----------------------------------------------------------------------------

-- | This is a shared seed used for follow-the-satoshi. This seed is
-- randomly generated by each party and eventually they agree on the
-- same value.
newtype SharedSeed = SharedSeed
    { getSharedSeed :: ByteString
    } deriving (Show, Eq, Ord, Generic, NFData, Typeable)

instance Buildable SharedSeed where
    build = B16.formatBase16 . getSharedSeed

-- | 'NonEmpty' list of slot leaders.
type SlotLeaders = NonEmpty StakeholderId

----------------------------------------------------------------------------
-- Proxy signatures and delegation
----------------------------------------------------------------------------

-- | Proxy signature used in csl -- holds a pair of epoch
-- indices. Block is valid if it's epoch index is inside this range.
type ProxySigEpoch a = ProxySignature (EpochIndex, EpochIndex) a

-- | Same alias for the proxy secret key (see 'ProxySigEpoch').
type ProxySKEpoch = ProxySecretKey (EpochIndex, EpochIndex)

-- | Simple proxy signature without ttl/epoch index constraints.
type ProxySigSimple a = ProxySignature () a

-- | Correspondent SK for no-ttl proxy signature scheme.
type ProxySKSimple = ProxySecretKey ()

-- | Some proxy secret key.
type ProxySKEither = Either ProxySKEpoch ProxySKSimple

----------------------------------------------------------------------------
-- GenericBlock
----------------------------------------------------------------------------

-- | Blockchain type class generalizes some functionality common for
-- different blockchains.
class Blockchain p where
    -- | Proof of data stored in the body. Ensures immutability.
    data BodyProof p :: *
    -- | Consensus data which can be used to check consensus properties.
    data ConsensusData p :: *
    -- | Whatever extra data.
    type ExtraHeaderData p :: *
    type ExtraHeaderData p = ()
    -- | Block header used in this blockchain.
    type BBlockHeader p :: *
    type BBlockHeader p = GenericBlockHeader p
    -- | Hash of 'BBlockHeader'. This is something like @Hash (BBlockHeader p)@.
    type BHeaderHash p :: *
    type BHeaderHash p = HeaderHash

    -- | Body contains payload and other heavy data.
    data Body p :: *
    -- | Whatever extra data.
    type ExtraBodyData p :: *
    type ExtraBodyData p = ()
    -- | Block used in this blockchain.
    type BBlock p :: *
    type BBlock p = GenericBlock p

    mkBodyProof :: Body p -&gt; BodyProof p
    checkBodyProof :: Body p -&gt; BodyProof p -&gt; Bool
    default checkBodyProof :: Eq (BodyProof p) =&gt; Body p -&gt; BodyProof p -&gt; Bool
    checkBodyProof body proof = mkBodyProof body == proof

-- | Header of block contains some kind of summary. There are various
-- benefits which people get by separating header from other data.
data GenericBlockHeader b = GenericBlockHeader
    { -- | Pointer to the header of the previous block.
      _gbhPrevBlock :: !(BHeaderHash b)
    , -- | Proof of body.
      _gbhBodyProof :: !(BodyProof b)
    , -- | Consensus data to verify consensus algorithm.
      _gbhConsensus :: !(ConsensusData b)
    , -- | Any extra data.
      _gbhExtra     :: !(ExtraHeaderData b)
    } deriving (Generic)

deriving instance ( Show (BHeaderHash b)
                  , Show (BodyProof b)
                  , Show (ConsensusData b)
                  , Show (ExtraHeaderData b)
                  ) =&gt; Show (GenericBlockHeader b)

deriving instance ( Eq (BHeaderHash b)
                  , Eq (BodyProof b)
                  , Eq (ConsensusData b)
                  , Eq (ExtraHeaderData b)
                  ) =&gt; Eq (GenericBlockHeader b)

-- | In general Block consists of header and body. It may contain
-- extra data as well.
data GenericBlock b = GenericBlock
    { _gbHeader :: !(GenericBlockHeader b)
    , _gbBody   :: !(Body b)
    , _gbExtra  :: !(ExtraBodyData b)
    } deriving (Generic)

deriving instance
         (Show (GenericBlockHeader b), Show (Body b),
          Show (ExtraBodyData b)) =&gt;
         Show (GenericBlock b)

deriving instance ( Eq (BHeaderHash b)
                  , Eq (Body b)
                  , Eq (BodyProof b)
                  , Eq (ConsensusData b)
                  , Eq (ExtraBodyData b)
                  , Eq (ExtraHeaderData b)
                  ) =&gt; Eq (GenericBlock b)

----------------------------------------------------------------------------
-- MainBlock
----------------------------------------------------------------------------

-- | Represents blockchain consisting of main blocks, i. e. blocks
-- with transactions and MPC messages.
data MainBlockchain ssc

-- | Chain difficulty represents necessary effort to generate a
-- chain. In the simplest case it can be number of blocks in chain.
newtype ChainDifficulty = ChainDifficulty
    { getChainDifficulty :: Word64
    } deriving (Show, Eq, Ord, Num, Enum, Real, Integral, Generic, Buildable, Typeable)

-- | Data to be signed in main block.
type MainToSign ssc = (HeaderHash, BodyProof (MainBlockchain ssc), SlotId, ChainDifficulty)

-- | Signature of the block. Can be either regular signature from the
-- issuer or delegated signature having a constraint on epoch indices
-- (it means the signature is valid only if block's slot id has epoch
-- inside the constrained interval).
data BlockSignature ssc
    = BlockSignature (Signature (MainToSign ssc))
    | BlockPSignatureEpoch (ProxySigEpoch (MainToSign ssc))
    | BlockPSignatureSimple (ProxySigSimple (MainToSign ssc))
    deriving (Show, Eq)

instance Buildable (BlockSignature ssc) where
    build (BlockSignature s)        = bprint (&quot;BlockSignature: &quot;%build) s
    build (BlockPSignatureEpoch s)  = bprint (&quot;BlockPSignatureEpoch: &quot;%build) s
    build (BlockPSignatureSimple s) = bprint (&quot;BlockPSignatureSimple: &quot;%build) s

-- | Represents main block body attributes: map from 1-byte integer to
-- arbitrary-type value. To be used for extending block with new
-- fields via softfork.
type BlockBodyAttributes = Attributes ()

-- | Represents main block header attributes: map from 1-byte integer to
-- arbitrary-type value. To be used for extending header with new
-- fields via softfork.
type BlockHeaderAttributes = Attributes ()

-- | Represents main block header extra data
data MainExtraHeaderData = MainExtraHeaderData
    { -- | Version of block.
      _mehBlockVersion    :: !BlockVersion
    , -- | Software version.
      _mehSoftwareVersion :: !SoftwareVersion
    , -- | Header attributes
      _mehAttributes      :: !BlockHeaderAttributes
    }
    deriving (Eq, Show, Generic)

instance Buildable MainExtraHeaderData where
    build MainExtraHeaderData {..} =
      bprint ( &quot;    block: v&quot;%build%&quot;\n&quot;
             % &quot;    software: &quot;%build%&quot;\n&quot;
             )
            _mehBlockVersion
            _mehSoftwareVersion

-- | Represents main block extra data
newtype MainExtraBodyData = MainExtraBodyData
    { _mebAttributes  :: BlockBodyAttributes
    } deriving (Eq, Show, Generic)

instance Buildable MainExtraBodyData where
    -- Currently there is no extra data in block body, attributes are empty.
    build _ = bprint &quot;no extra data&quot;

instance (Ssc ssc, Bi TxWitness, Bi UpdatePayload) =&gt;
         Blockchain (MainBlockchain ssc) where
    -- | Proof of transactions list and MPC data.
    data BodyProof (MainBlockchain ssc) = MainProof
        { mpNumber        :: !Word32
        , mpRoot          :: !(MerkleRoot Tx)
        , mpWitnessesHash :: !(Hash [TxWitness])
        , mpMpcProof      :: !(SscProof ssc)
        , mpProxySKsProof :: !(Hash [ProxySKSimple])
        , mpUpdateProof   :: !UpdateProof
        } deriving (Generic)
    data ConsensusData (MainBlockchain ssc) = MainConsensusData
        { -- | Id of the slot for which this block was generated.
        _mcdSlot       :: !SlotId
        , -- | Public key of slot leader. Maybe later we'll see it is redundant.
        _mcdLeaderKey  :: !PublicKey
        , -- | Difficulty of chain ending in this block.
        _mcdDifficulty :: !ChainDifficulty
        , -- | Signature given by slot leader.
        _mcdSignature  :: !(BlockSignature ssc)
        } deriving (Generic, Show, Eq)
    type BBlockHeader (MainBlockchain ssc) = BlockHeader ssc
    type ExtraHeaderData (MainBlockchain ssc) = MainExtraHeaderData

    -- | In our cryptocurrency, body consists of a list of transactions
    -- and MPC messages.
    data Body (MainBlockchain ssc) = MainBody
        { -- | Transactions are the main payload.
          -- TODO: currently we don't know for sure whether it should be
          -- serialized as a MerkleTree or something list-like.
          _mbTxs :: !(MerkleTree Tx)
        , -- | Distributions for P2SH addresses in transaction outputs.
          --     * length mbTxAddrDistributions == length mbTxs
          --     * i-th element is 'Just' if at least one output of i-th
          --         transaction is P2SH
          --     * n-th element of i-th element is 'Just' if n-th output
          --         of i-th transaction is P2SH
          -- Ask @neongreen if you don't understand wtf is going on.
          -- Basically, address distributions are needed so that (potential)
          -- receivers of P2SH funds would count as stakeholders.
          _mbTxAddrDistributions :: ![TxDistribution]
        , -- | Transaction witnesses. Invariant: there are as many witnesses
          -- as there are transactions in the block. This is checked during
          -- deserialisation. We can't put them into the same Merkle tree
          -- with transactions, as the whole point of segwit is to separate
          -- transactions and witnesses.
          --
          -- TODO: should they be put into a separate Merkle tree or left as
          -- a list?
          _mbWitnesses :: ![TxWitness]
        , -- | Data necessary for MPC.
          _mbMpc :: !(SscPayload ssc)
        , -- | No-ttl heavyweight delegation certificates
          _mbProxySKs :: ![ProxySKSimple]
          -- | Additional update information for update system.
        , _mbUpdatePayload :: !UpdatePayload
        } deriving (Generic, Typeable)

    type ExtraBodyData (MainBlockchain ssc) = MainExtraBodyData
    type BBlock (MainBlockchain ssc) = Block ssc

    mkBodyProof MainBody{..} =
        MainProof
        { mpNumber = fromIntegral (length _mbTxs)
        , mpRoot = mtRoot _mbTxs
        , mpWitnessesHash = hash _mbWitnesses
        , mpMpcProof = untag @ssc mkSscProof _mbMpc
        , mpProxySKsProof = hash _mbProxySKs
        , mpUpdateProof = mkUpdateProof _mbUpdatePayload
        }


--deriving instance Ssc ssc =&gt; Show (SscProof ssc)
--deriving instance Ssc ssc =&gt; Eq (SscProof ssc)
deriving instance Ssc ssc =&gt; Show (BodyProof (MainBlockchain ssc))
deriving instance Ssc ssc =&gt; Eq (BodyProof (MainBlockchain ssc))
deriving instance Ssc ssc =&gt; Show (Body (MainBlockchain ssc))
deriving instance (Eq (SscPayload ssc), Ssc ssc) =&gt; Eq (Body (MainBlockchain ssc))

-- | Header of generic main block.
type MainBlockHeader ssc = GenericBlockHeader (MainBlockchain ssc)

-- | Ssc w/ buildable blockchain
type BiSsc ssc =
    ( Ssc ssc
    , Bi (GenericBlockHeader (GenesisBlockchain ssc))
    , Bi (GenericBlockHeader (MainBlockchain ssc)))

instance BiSsc ssc =&gt; Buildable (MainBlockHeader ssc) where
    build gbh@GenericBlockHeader {..} =
        bprint
            (&quot;MainBlockHeader:\n&quot;%
             &quot;    hash: &quot;%hashHexF%&quot;\n&quot;%
             &quot;    previous block: &quot;%hashHexF%&quot;\n&quot;%
             &quot;    slot: &quot;%slotIdF%&quot;\n&quot;%
             &quot;    leader: &quot;%build%&quot;\n&quot;%
             &quot;    difficulty: &quot;%int%&quot;\n&quot;%
             build
            )
            gbhHeaderHash
            _gbhPrevBlock
            _mcdSlot
            _mcdLeaderKey
            _mcdDifficulty
            _gbhExtra
      where
        gbhHeaderHash :: HeaderHash
        gbhHeaderHash = blockHeaderHash $ Right gbh
        MainConsensusData {..} = _gbhConsensus

-- | MainBlock is a block with transactions and MPC messages. It's the
-- main part of our consensus algorithm.
type MainBlock ssc = GenericBlock (MainBlockchain ssc)

instance BiSsc ssc =&gt; Buildable (MainBlock ssc) where
    build GenericBlock {..} =
        bprint
            (stext%&quot;:\n&quot;%
             &quot;  &quot;%build%
             &quot;  transactions (&quot;%int%&quot; items): &quot;%listJson%&quot;\n&quot;%
             &quot;  certificates (&quot;%int%&quot; items): &quot;%listJson%&quot;\n&quot;%
             build%&quot;\n&quot;%
             &quot;  update payload: &quot;%build%&quot;\n&quot;%
             build
            )
            (colorize Magenta &quot;MainBlock&quot;)
            _gbHeader
            (length _mbTxs)
            _mbTxs
            (length _mbProxySKs)
            _mbProxySKs
            _mbMpc
            _mbUpdatePayload
            _gbExtra
      where
        MainBody {..} = _gbBody

----------------------------------------------------------------------------
-- GenesisBlock
----------------------------------------------------------------------------

-- | Represents blockchain consisting of genesis blocks.  Genesis
-- block doesn't have any special payload and is not strictly
-- necessary. However, it is good idea to store list of leaders
-- explicitly, because calculating it may be expensive operation. For
-- example, it is useful for SPV-clients.
data GenesisBlockchain ssc

-- | Header of Genesis block.
type GenesisBlockHeader ssc = GenericBlockHeader (GenesisBlockchain ssc)

instance Blockchain (GenesisBlockchain ssc) where
    -- [CSL-199]: maybe we should use ADS.
    -- | Proof of GenesisBody is just a hash of slot leaders list.
    data BodyProof (GenesisBlockchain ssc) = GenesisProof
        !(Hash SlotLeaders)
        deriving (Eq, Generic, Show)
    data ConsensusData (GenesisBlockchain ssc) = GenesisConsensusData
        { -- | Index of the slot for which this genesis block is relevant.
          _gcdEpoch :: !EpochIndex
        , -- | Difficulty of the chain ending in this genesis block.
          _gcdDifficulty :: !ChainDifficulty
        } deriving (Generic, Show, Eq)
    type BBlockHeader (GenesisBlockchain ssc) = BlockHeader ssc

    -- | Body of genesis block consists of slot leaders for epoch
    -- associated with this block.
    data Body (GenesisBlockchain ssc) = GenesisBody
        { _gbLeaders :: !SlotLeaders
        } deriving (Generic, Show, Eq)
    type BBlock (GenesisBlockchain ssc) = Block ssc

    mkBodyProof = GenesisProof . hash . _gbLeaders

-- | Genesis block parametrized by 'GenesisBlockchain'.
type GenesisBlock ssc = GenericBlock (GenesisBlockchain ssc)

instance BiSsc ssc =&gt; Buildable (GenesisBlock ssc) where
    build GenericBlock {..} =
        bprint
            (stext%&quot;:\n&quot;%
             &quot;  &quot;%build%
             stext
            )
            (colorize Magenta &quot;GenesisBlock&quot;)
            _gbHeader
            formatLeaders
      where
        GenesisBody {..} = _gbBody
        formatIfNotNull formatter l = if null l then mempty else sformat formatter l
        formatLeaders = formatIfNotNull
            (&quot;  leaders: &quot;%listJson%&quot;\n&quot;) _gbLeaders

instance BiSsc ssc =&gt; Buildable (GenesisBlockHeader ssc) where
    build gbh@GenericBlockHeader {..} =
        bprint
            (&quot;GenesisBlockHeader:\n&quot;%
             &quot;    hash: &quot;%hashHexF%&quot;\n&quot;%
             &quot;    previous block: &quot;%hashHexF%&quot;\n&quot;%
             &quot;    epoch: &quot;%build%&quot;\n&quot;%
             &quot;    difficulty: &quot;%int%&quot;\n&quot;
            )
            gbhHeaderHash
            _gbhPrevBlock
            _gcdEpoch
            _gcdDifficulty
      where
        gbhHeaderHash :: HeaderHash
        gbhHeaderHash = blockHeaderHash $ Left gbh
        GenesisConsensusData {..} = _gbhConsensus

----------------------------------------------------------------------------
-- GenesisBlock &#8746; MainBlock
----------------------------------------------------------------------------

-- | Either header of ordinary main block or genesis block.
type BlockHeader ssc = Either (GenesisBlockHeader ssc) (MainBlockHeader ssc)

instance BiSsc ssc =&gt; Buildable (BlockHeader ssc) where
    build = either Buildable.build Buildable.build

-- | Lens from 'Block' to 'BlockHeader'.
--
-- This gives a &#8220;redundant constraint&#8221; message warning which will be fixed in
-- lens-4.15 (not in LTS yet).
blockHeader :: Getter (Block ssc) (BlockHeader ssc)
blockHeader = to getBlockHeader

-- | Take 'BlockHeader' from either 'GenesisBlock' or 'MainBlock'.
getBlockHeader :: Block ssc -&gt; BlockHeader ssc
getBlockHeader = bimap _gbHeader _gbHeader

-- | 'Hash' of block header. This should be @Hash (BlockHeader ssc)@
-- but we don't want to have @ssc@ in 'HeaderHash' type.
type HeaderHash = Hash BlockHeaderStub
data BlockHeaderStub

-- | Class for something that has 'HeaderHash'.
class HasHeaderHash a where
    headerHash :: a -&gt; HeaderHash
    headerHashG :: Getter a HeaderHash
    headerHashG = to headerHash

-- | This function is required because type inference fails in attempts to
-- hash only @Right@ or @Left@.
blockHeaderHash :: BiSsc ssc =&gt; BlockHeader ssc -&gt; HeaderHash
blockHeaderHash = headerHash

instance HasHeaderHash HeaderHash where
    headerHash = identity

instance BiSsc ssc =&gt; HasHeaderHash (MainBlockHeader ssc) where
    headerHash = blockHeaderHash . Right

instance BiSsc ssc =&gt; HasHeaderHash (GenesisBlockHeader ssc) where
    headerHash = blockHeaderHash . Left

instance BiSsc ssc =&gt; HasHeaderHash (BlockHeader ssc) where
    headerHash = unsafeHash

instance BiSsc ssc =&gt; HasHeaderHash (MainBlock ssc) where
    headerHash = blockHeaderHash . Right . _gbHeader

instance BiSsc ssc =&gt; HasHeaderHash (GenesisBlock ssc) where
    headerHash = blockHeaderHash . Left  . _gbHeader

instance BiSsc ssc =&gt; HasHeaderHash (Block ssc) where
    headerHash = blockHeaderHash . getBlockHeader

-- | Specialized formatter for 'HeaderHash'.
headerHashF :: Format r (HeaderHash -&gt; r)
headerHashF = build

-- | Block.
type Block ssc = Either (GenesisBlock ssc) (MainBlock ssc)

----------------------------------------------------------------------------
-- Lenses. [CSL-193]: move to Block.hs and other modules or leave them here?
----------------------------------------------------------------------------

makeLenses ''GenericBlockHeader
makeLenses ''GenericBlock

makeLenses ''MainExtraHeaderData
makeLenses ''MainExtraBodyData

-- !!! Create issue about this on lens github or give link on existing issue !!!
-- 'makeLensesData' doesn't work with types with parameters. I don't
-- know how to design a 'makeLensesData' which would work with them (in fact,
-- I don't even know how an invocation of 'makeLensesData' would look like)

#define MAKE_LENS(l, field) l f s = (\y -&gt; s {field = y}) &lt;$&gt; f (field s)

-- makeLensesData ''ConsensusData ''(MainBlockchain ssc)

-- | Lens for 'SlotId' of 'MainBlockchain' in 'ConsensusData'.
mcdSlot :: Lens' (ConsensusData (MainBlockchain ssc)) SlotId
MAKE_LENS(mcdSlot, _mcdSlot)

-- | Lens for 'PublicKey' of 'MainBlockchain' in 'ConsensusData'.
mcdLeaderKey :: Lens' (ConsensusData (MainBlockchain ssc)) PublicKey
MAKE_LENS(mcdLeaderKey, _mcdLeaderKey)

-- | Lens for 'ChainDifficulty' of 'MainBlockchain' in 'ConsensusData'.
mcdDifficulty :: Lens' (ConsensusData (MainBlockchain ssc)) ChainDifficulty
MAKE_LENS(mcdDifficulty, _mcdDifficulty)

-- | Lens for 'Signature' of 'MainBlockchain' in 'ConsensusData'.
mcdSignature :: Lens' (ConsensusData (MainBlockchain ssc)) (BlockSignature ssc)
MAKE_LENS(mcdSignature, _mcdSignature)

-- makeLensesData ''ConsensusData ''(GenesisBlockchain ssc)

-- | Lens for 'EpochIndex' of 'GenesisBlockchain' in 'ConsensusData'.
gcdEpoch :: Lens' (ConsensusData (GenesisBlockchain ssc)) EpochIndex
MAKE_LENS(gcdEpoch, _gcdEpoch)

-- | Lens for 'ChainDifficulty' of 'GenesisBlockchain' in 'ConsensusData'.
gcdDifficulty :: Lens' (ConsensusData (GenesisBlockchain ssc)) ChainDifficulty
MAKE_LENS(gcdDifficulty, _gcdDifficulty)

-- makeLensesData ''Body ''(MainBlockchain ssc)

-- | Lens for transaction tree in main block body.
mbTxs :: Lens' (Body (MainBlockchain ssc)) (MerkleTree Tx)
MAKE_LENS(mbTxs, _mbTxs)

-- | Lens for witness list in main block body.
mbWitnesses :: Lens' (Body (MainBlockchain ssc)) [TxWitness]
MAKE_LENS(mbWitnesses, _mbWitnesses)

-- | Lens for distributions list in main block body.
mbTxAddrDistributions :: Lens' (Body (MainBlockchain ssc)) [TxDistribution]
MAKE_LENS(mbTxAddrDistributions, _mbTxAddrDistributions)

-- | Lens for 'SscPayload' in main block body.
mbMpc :: Lens' (Body (MainBlockchain ssc)) (SscPayload ssc)
MAKE_LENS(mbMpc, _mbMpc)

-- | Lens for ProxySKs in main block body.
mbProxySKs :: Lens' (Body (MainBlockchain ssc)) [ProxySKSimple]
MAKE_LENS(mbProxySKs, _mbProxySKs)

-- | Lens for 'UpdatePayload' in main block body.
mbUpdatePayload :: Lens' (Body (MainBlockchain ssc)) UpdatePayload
MAKE_LENS(mbUpdatePayload, _mbUpdatePayload)

-- makeLensesData ''Body ''(GenesisBlockchain ssc)

-- | Lens for 'SlotLeaders' in 'Body' of 'GenesisBlockchain'.
gbLeaders :: Lens' (Body (GenesisBlockchain ssc)) SlotLeaders
MAKE_LENS(gbLeaders, _gbLeaders)

-- | Lens from 'GenericBlock' to 'BodyProof'.
gbBodyProof :: Lens' (GenericBlock b) (BodyProof b)
gbBodyProof = gbHeader . gbhBodyProof

-- | Lens from 'MainBlockHeader' to 'SlotId'.
headerSlot :: Lens' (MainBlockHeader ssc) SlotId
headerSlot = gbhConsensus . mcdSlot

-- | Lens from 'MainBlockHeader' to 'PublicKey'.
headerLeaderKey :: Lens' (MainBlockHeader ssc) PublicKey
headerLeaderKey = gbhConsensus . mcdLeaderKey

-- | Lens from 'MainBlockHeader' to 'Signature'.
headerSignature :: Lens' (MainBlockHeader ssc) (BlockSignature ssc)
headerSignature = gbhConsensus . mcdSignature

-- | Type class for something that has 'ChainDifficulty'.
class HasDifficulty a where
    difficultyL :: Lens' a ChainDifficulty

instance HasDifficulty (ConsensusData (MainBlockchain ssc)) where
    difficultyL = mcdDifficulty

instance HasDifficulty (ConsensusData (GenesisBlockchain ssc)) where
    difficultyL = gcdDifficulty

instance HasDifficulty (MainBlockHeader ssc) where
    difficultyL = gbhConsensus . difficultyL

instance HasDifficulty (GenesisBlockHeader ssc) where
    difficultyL = gbhConsensus . difficultyL

instance HasDifficulty (BlockHeader ssc) where
    difficultyL = choosing difficultyL difficultyL

instance HasDifficulty (MainBlock ssc) where
    difficultyL = gbHeader . difficultyL

instance HasDifficulty (GenesisBlock ssc) where
    difficultyL = gbHeader . difficultyL

instance HasDifficulty (Block ssc) where
    difficultyL = choosing difficultyL difficultyL

-- | Class for something that has previous block (lens to 'Hash' for this block).
class HasPrevBlock s where
    prevBlockL :: Lens' s HeaderHash

instance HasPrevBlock s =&gt; HasPrevBlock (s, z) where
    prevBlockL = _1 . prevBlockL

instance (BHeaderHash b ~ HeaderHash) =&gt;
         HasPrevBlock (GenericBlockHeader b) where
    prevBlockL = gbhPrevBlock

instance (BHeaderHash b ~ HeaderHash) =&gt;
         HasPrevBlock (GenericBlock b) where
    prevBlockL = gbHeader . gbhPrevBlock

instance (HasPrevBlock s, HasPrevBlock s') =&gt;
         HasPrevBlock (Either s s') where
    prevBlockL = choosing prevBlockL prevBlockL

-- | Class for something that has 'EpochIndex'.
class HasEpochIndex a where
    epochIndexL :: Lens' a EpochIndex

instance HasEpochIndex SlotId where
    epochIndexL f SlotId {..} = (\a -&gt; SlotId {siEpoch = a, ..}) &lt;$&gt; f siEpoch

instance HasEpochIndex (MainBlock ssc) where
    epochIndexL = gbHeader . gbhConsensus . mcdSlot . epochIndexL

instance HasEpochIndex (MainBlockHeader ssc) where
    epochIndexL = gbhConsensus . mcdSlot . epochIndexL

instance HasEpochIndex (GenesisBlock ssc) where
    epochIndexL = gbHeader . gbhConsensus . gcdEpoch

instance HasEpochIndex (GenesisBlockHeader ssc) where
    epochIndexL = gbhConsensus . gcdEpoch

instance (HasEpochIndex a, HasEpochIndex b) =&gt;
         HasEpochIndex (Either a b) where
    epochIndexL = choosing epochIndexL epochIndexL

-- | Lens from 'MainBlock' to 'SlotId'.
blockSlot :: Lens' (MainBlock ssc) SlotId
blockSlot = gbHeader . headerSlot

-- | Lens from 'MainBlock' to 'PublicKey'.
blockLeaderKey :: Lens' (MainBlock ssc) PublicKey
blockLeaderKey = gbHeader . headerLeaderKey

-- | Lens from 'MainBlock' to 'Signature'.
blockSignature :: Lens' (MainBlock ssc) (BlockSignature ssc)
blockSignature = gbHeader . headerSignature

-- | Lens from 'MainBlock' to 'SscPayload'.
blockMpc :: Lens' (MainBlock ssc) (SscPayload ssc)
blockMpc = gbBody . mbMpc

-- | Lens from 'MainBlock' to 'MerkleTree'.
blockTxs :: Lens' (MainBlock ssc) (MerkleTree Tx)
blockTxs = gbBody . mbTxs

-- | Getter from 'MainBlock' to a list of transactions together with
-- auxiliary data.
blockTxas :: Getter (MainBlock ssc) [TxAux]
blockTxas =
    gbBody .
    to (\b -&gt; zip3 (toList (b ^. mbTxs))
                   (b ^. mbWitnesses)
                   (b ^. mbTxAddrDistributions))

-- | Lens from 'MainBlock' to 'ProxySKSimple' list.
blockProxySKs :: Lens' (MainBlock ssc) [ProxySKSimple]
blockProxySKs = gbBody . mbProxySKs

-- | Lens from 'GenesisBlock' to 'SlotLeaders'.
blockLeaders :: Lens' (GenesisBlock ssc) SlotLeaders
blockLeaders = gbBody . gbLeaders


class HasEpochOrSlot a where
    _getEpochOrSlot :: a -&gt; Either EpochIndex SlotId
    getEpochOrSlot :: a -&gt; EpochOrSlot
    getEpochOrSlot = EpochOrSlot . _getEpochOrSlot
    epochOrSlotG :: Getter a EpochOrSlot
    epochOrSlotG = to getEpochOrSlot

instance HasEpochOrSlot (MainBlockHeader ssc) where
    _getEpochOrSlot = Right . _mcdSlot . _gbhConsensus

instance HasEpochOrSlot (GenesisBlockHeader ssc) where
    _getEpochOrSlot = Left . _gcdEpoch . _gbhConsensus

instance HasEpochOrSlot (MainBlock ssc) where
    _getEpochOrSlot = _getEpochOrSlot . _gbHeader

instance HasEpochOrSlot (GenesisBlock ssc) where
    _getEpochOrSlot = _getEpochOrSlot . _gbHeader

instance (HasEpochOrSlot a, HasEpochOrSlot b) =&gt;
         HasEpochOrSlot (Either a b) where
    _getEpochOrSlot = either _getEpochOrSlot _getEpochOrSlot

----------------------------------------------------------------------------
-- SafeCopy instances
----------------------------------------------------------------------------

-- These instances are all gathered at the end because otherwise we'd have to
-- sort types topologically

deriveSafeCopySimple 0 'base ''EpochIndex
deriveSafeCopySimple 0 'base ''LocalSlotIndex
deriveSafeCopySimple 0 'base ''SlotId
deriveSafeCopySimple 0 'base ''Coin
deriveSafeCopySimple 0 'base ''Address
deriveSafeCopySimple 0 'base ''TxInWitness
-- TODO: in many cases TxDistribution would just be lots of empty lists, so
-- its SafeCopy instance could be optimised
deriveSafeCopySimple 0 'base ''TxDistribution
deriveSafeCopySimple 0 'base ''TxIn
deriveSafeCopySimple 0 'base ''TxOut
deriveSafeCopySimple 0 'base ''Tx
deriveSafeCopySimple 0 'base ''SharedSeed

deriveSafeCopySimple 0 'base ''MainExtraBodyData
deriveSafeCopySimple 0 'base ''MainExtraHeaderData

-- Manually written instances can't be derived because
-- 'deriveSafeCopySimple' is not clever enough to add
-- &#8220;SafeCopy (Whatever a) =&gt;&#8221; constaints.
instance ( SafeCopy (BHeaderHash b)
         , SafeCopy (BodyProof b)
         , SafeCopy (ConsensusData b)
         , SafeCopy (ExtraHeaderData b)
         ) =&gt;
         SafeCopy (GenericBlockHeader b) where
    getCopy =
        contain $
        do _gbhPrevBlock &lt;- safeGet
           _gbhBodyProof &lt;- safeGet
           _gbhConsensus &lt;- safeGet
           _gbhExtra &lt;- safeGet
           return $! GenericBlockHeader {..}
    putCopy GenericBlockHeader {..} =
        contain $
        do safePut _gbhPrevBlock
           safePut _gbhBodyProof
           safePut _gbhConsensus
           safePut _gbhExtra

instance ( SafeCopy (BHeaderHash b)
         , SafeCopy (BodyProof b)
         , SafeCopy (ConsensusData b)
         , SafeCopy (ExtraHeaderData b)
         , SafeCopy (Body b)
         , SafeCopy (ExtraBodyData b)
         ) =&gt;
         SafeCopy (GenericBlock b) where
    getCopy =
        contain $
        do _gbHeader &lt;- safeGet
           _gbBody &lt;- safeGet
           _gbExtra &lt;- safeGet
           return $! GenericBlock {..}
    putCopy GenericBlock {..} =
        contain $
        do safePut _gbHeader
           safePut _gbBody
           safePut _gbExtra

deriveSafeCopySimple 0 'base ''ChainDifficulty

instance (Ssc ssc, SafeCopy (SscProof ssc)) =&gt;
         SafeCopy (BodyProof (MainBlockchain ssc)) where
    getCopy = contain $ do
        mpNumber        &lt;- safeGet
        mpRoot          &lt;- safeGet
        mpWitnessesHash &lt;- safeGet
        mpMpcProof      &lt;- safeGet
        mpProxySKsProof &lt;- safeGet
        mpUpdateProof   &lt;- safeGet
        return $! MainProof{..}
    putCopy MainProof {..} = contain $ do
        safePut mpNumber
        safePut mpRoot
        safePut mpWitnessesHash
        safePut mpMpcProof
        safePut mpProxySKsProof
        safePut mpUpdateProof

instance SafeCopy (BodyProof (GenesisBlockchain ssc)) where
    getCopy =
        contain $
        do x &lt;- safeGet
           return $! GenesisProof x
    putCopy (GenesisProof x) =
        contain $
        do safePut x

instance SafeCopy (BlockSignature ssc) where
    getCopy = contain $ Cereal.getWord8 &gt;&gt;= \case
        0 -&gt; BlockSignature &lt;$&gt; safeGet
        1 -&gt; BlockPSignatureEpoch &lt;$&gt; safeGet
        2 -&gt; BlockPSignatureSimple &lt;$&gt; safeGet
        t -&gt; fail $ &quot;getCopy@BlockSignature: couldn't read tag: &quot; &lt;&gt; show t
    putCopy (BlockSignature sig)       = contain $ Cereal.putWord8 0 &gt;&gt; safePut sig
    putCopy (BlockPSignatureEpoch proxySig) = contain $ Cereal.putWord8 1 &gt;&gt; safePut proxySig
    putCopy (BlockPSignatureSimple proxySig) = contain $ Cereal.putWord8 2 &gt;&gt; safePut proxySig

instance SafeCopy (ConsensusData (MainBlockchain ssc)) where
    getCopy =
        contain $
        do _mcdSlot &lt;- safeGet
           _mcdLeaderKey &lt;- safeGet
           _mcdDifficulty &lt;- safeGet
           _mcdSignature &lt;- safeGet
           return $! MainConsensusData {..}
    putCopy MainConsensusData {..} =
        contain $
        do safePut _mcdSlot
           safePut _mcdLeaderKey
           safePut _mcdDifficulty
           safePut _mcdSignature

instance SafeCopy (ConsensusData (GenesisBlockchain ssc)) where
    getCopy =
        contain $
        do _gcdEpoch &lt;- safeGet
           _gcdDifficulty &lt;- safeGet
           return $! GenesisConsensusData {..}
    putCopy GenesisConsensusData {..} =
        contain $
        do safePut _gcdEpoch
           safePut _gcdDifficulty

instance (Ssc ssc, SafeCopy (SscPayload ssc)) =&gt;
         SafeCopy (Body (MainBlockchain ssc)) where
    getCopy = contain $ do
        _mbTxs                 &lt;- safeGet
        _mbWitnesses           &lt;- safeGet
        _mbTxAddrDistributions &lt;- safeGet
        _mbMpc                 &lt;- safeGet
        _mbProxySKs            &lt;- safeGet
        _mbUpdatePayload       &lt;- safeGet
        return $! MainBody{..}
    putCopy MainBody {..} = contain $ do
        safePut _mbTxs
        safePut _mbWitnesses
        safePut _mbTxAddrDistributions
        safePut _mbMpc
        safePut _mbProxySKs
        safePut _mbUpdatePayload

instance SafeCopy (Body (GenesisBlockchain ssc)) where
    getCopy =
        contain $
        do _gbLeaders &lt;- safeGet
           return $! GenesisBody {..}
    putCopy GenesisBody {..} =
        contain $
        do safePut _gbLeaders

----------------------------------------------------------------------------
-- Other derived instances
----------------------------------------------------------------------------

derive makeNFData ''TxIn
derive makeNFData ''TxInWitness
derive makeNFData ''TxOut
derive makeNFData ''TxDistribution
derive makeNFData ''Tx
</span></pre></body></html>